name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Build & Deploy to Azure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Validate Azure OIDC inputs
        id: azure-oidc
        shell: bash
        run: |
          set -euo pipefail

          normalize() {
            local value="$1"
            # trim whitespace + surrounding quotes
            value="$(echo "$value" | xargs)"
            value="${value%\"}"
            value="${value#\"}"
            value="${value%'}"
            value="${value#'}"

            # allow full authority URLs and extract the tenant segment
            value="${value#https://login.microsoftonline.com/}"
            value="${value#http://login.microsoftonline.com/}"
            value="${value#https://sts.windows.net/}"
            value="${value%/v2.0}"
            value="${value%%/*}"
            echo "$value"
          }

          CLIENT_ID="$(normalize "${{ secrets.AZURE_CLIENT_ID }}")"
          TENANT_ID="$(normalize "${{ secrets.AZURE_TENANT_ID }}")"
          SUBSCRIPTION_ID="$(normalize "${{ secrets.AZURE_SUBSCRIPTION_ID }}")"

          if [[ -z "$CLIENT_ID" || -z "$TENANT_ID" || -z "$SUBSCRIPTION_ID" ]]; then
            echo "One or more required Azure secrets are empty after normalization."
            echo "Check AZURE_CLIENT_ID, AZURE_TENANT_ID, and AZURE_SUBSCRIPTION_ID in repo/environment secrets."
            exit 1
          fi

          if [[ ! "$TENANT_ID" =~ ^[0-9a-fA-F-]{36}$ ]] && [[ ! "$TENANT_ID" =~ ^[A-Za-z0-9.-]+$ ]]; then
            echo "AZURE_TENANT_ID appears malformed after normalization: $TENANT_ID"
            echo "Use a tenant GUID (recommended) or tenant domain (e.g. contoso.onmicrosoft.com)."
            exit 1
          fi

          {
            echo "client_id=$CLIENT_ID"
            echo "tenant_id=$TENANT_ID"
            echo "subscription_id=$SUBSCRIPTION_ID"
          } >> "$GITHUB_OUTPUT"

      - name: Login to Azure via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ steps.azure-oidc.outputs.client_id }}
          tenant-id: ${{ steps.azure-oidc.outputs.tenant_id }}
          subscription-id: ${{ steps.azure-oidc.outputs.subscription_id }}

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/agentbook:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/agentbook:latest

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          images: ${{ secrets.ACR_LOGIN_SERVER }}/agentbook:${{ github.sha }}

  smoke-test:
    name: Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Health check - Homepage
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net)
          echo "Homepage status: $STATUS"
          if [ "$STATUS" != "200" ]; then exit 1; fi

      - name: Health check - API
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/agents)
          echo "API status: $STATUS"
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "401" ]; then exit 1; fi

      - name: Print deployment URL
        run: echo "âœ… Deployed to https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net"

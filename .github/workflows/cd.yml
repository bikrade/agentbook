name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: cd-main
  cancel-in-progress: false

jobs:
  deploy:
    name: Build, Push Image, Deploy to Azure Web App
    runs-on: ubuntu-latest
    environment: production
    env:
      DEPLOY_TARGET_TYPE: webapp-container
      IMAGE_NAME: ${{ vars.IMAGE_NAME || 'agentbook' }}
      AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME || secrets.AZURE_WEBAPP_NAME }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP || secrets.AZURE_RESOURCE_GROUP }}
      ACR_NAME: ${{ vars.ACR_NAME || secrets.ACR_NAME }}
      ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER || secrets.ACR_LOGIN_SERVER }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION || 'unknown' }}
      AZURE_STORAGE_ACCOUNT: ${{ vars.AZURE_STORAGE_ACCOUNT || secrets.AZURE_STORAGE_ACCOUNT }}
      AZURE_STORAGE_RESOURCE_GROUP: ${{ vars.AZURE_STORAGE_RESOURCE_GROUP || secrets.AZURE_STORAGE_RESOURCE_GROUP }}
      AZURE_FILE_SHARE: ${{ vars.AZURE_FILE_SHARE || 'agentbook-sqlite' }}
      SQLITE_MOUNT_PATH: /home/data
      SQLITE_DB_FILENAME: dev.db
      OIDC_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID || secrets.AZURE_CLIENT_ID }}
      OIDC_TENANT_ID: ${{ vars.AZURE_TENANT_ID || secrets.AZURE_TENANT_ID }}
      OIDC_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID || secrets.AZURE_SUBSCRIPTION_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build app
        run: npm run build
        env:
          DATABASE_URL: "file:./prisma/dev.db"
          NEXTAUTH_SECRET: "build-secret"
          NEXTAUTH_URL: "http://localhost:3000"

      - name: Preflight config validation (non-sensitive)
        shell: bash
        run: |
          set -euo pipefail

          required_vars=(AZURE_WEBAPP_NAME ACR_LOGIN_SERVER AZURE_STORAGE_ACCOUNT)
          for name in "${required_vars[@]}"; do
            if [[ -z "${!name:-}" ]]; then
              echo "::error::Missing required config: ${name}. Set it in repository Variables (preferred) or Secrets."
              exit 1
            fi
          done

          if [[ -z "${ACR_NAME:-}" ]]; then
            ACR_NAME="${ACR_LOGIN_SERVER%%.*}"
            echo "Derived ACR_NAME=${ACR_NAME} from ACR_LOGIN_SERVER"
            echo "ACR_NAME=${ACR_NAME}" >> "$GITHUB_ENV"
          fi

          echo "Deploy target type: ${DEPLOY_TARGET_TYPE}"
          echo "Azure resource group: ${AZURE_RESOURCE_GROUP:-<auto-discover>}"
          echo "Azure Web App name: ${AZURE_WEBAPP_NAME}"
          echo "ACR login server: ${ACR_LOGIN_SERVER}"
          echo "Azure location: ${AZURE_LOCATION}"
          echo "Storage account: ${AZURE_STORAGE_ACCOUNT}"
          echo "Storage share: ${AZURE_FILE_SHARE}"
          echo "SQLite mount path: ${SQLITE_MOUNT_PATH}"

      - name: Normalize Azure OIDC IDs
        id: azure-oidc
        shell: bash
        run: |
          set -euo pipefail

          normalize() {
            local value="$1"
            value="$(echo "$value" | xargs)"
            value="${value%\"}"
            value="${value#\"}"
            value="${value%\'}"
            value="${value#\'}"
            value="${value#https://login.microsoftonline.com/}"
            value="${value#http://login.microsoftonline.com/}"
            value="${value#https://sts.windows.net/}"
            value="${value%/v2.0}"
            value="${value%%/*}"
            echo "$value"
          }

          CLIENT_ID="$(normalize "${OIDC_CLIENT_ID:-}")"
          TENANT_ID="$(normalize "${OIDC_TENANT_ID:-}")"
          SUBSCRIPTION_ID="$(normalize "${OIDC_SUBSCRIPTION_ID:-}")"

          if [[ -z "$CLIENT_ID" || -z "$TENANT_ID" || -z "$SUBSCRIPTION_ID" ]]; then
            echo "::error::AZURE_CLIENT_ID, AZURE_TENANT_ID, and AZURE_SUBSCRIPTION_ID must all be set."
            exit 1
          fi

          if [[ ! "$TENANT_ID" =~ ^[0-9a-fA-F-]{36}$ ]] && [[ ! "$TENANT_ID" =~ ^[A-Za-z0-9.-]+$ ]]; then
            echo "::error::AZURE_TENANT_ID is malformed after normalization. Use a tenant GUID (recommended) or tenant domain."
            exit 1
          fi

          {
            echo "client_id=$CLIENT_ID"
            echo "tenant_id=$TENANT_ID"
            echo "subscription_id=$SUBSCRIPTION_ID"
          } >> "$GITHUB_OUTPUT"

      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ steps.azure-oidc.outputs.client_id }}
          tenant-id: ${{ steps.azure-oidc.outputs.tenant_id }}
          subscription-id: ${{ steps.azure-oidc.outputs.subscription_id }}

      - name: Confirm Azure subscription
        shell: bash
        run: |
          set -euo pipefail
          az account show --output table

      - name: Resolve resource group when not provided
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${AZURE_RESOURCE_GROUP:-}" ]]; then
            RG="$(az webapp list --query "[?name=='${AZURE_WEBAPP_NAME}'].resourceGroup | [0]" -o tsv)"
            if [[ -z "$RG" ]]; then
              echo "::error::Could not resolve resource group for web app '${AZURE_WEBAPP_NAME}'. Set AZURE_RESOURCE_GROUP in repo Variables/Secrets."
              exit 1
            fi
            echo "Resolved Azure resource group: $RG"
            echo "AZURE_RESOURCE_GROUP=$RG" >> "$GITHUB_ENV"
          fi

          if [[ -z "${AZURE_STORAGE_RESOURCE_GROUP:-}" ]]; then
            echo "AZURE_STORAGE_RESOURCE_GROUP=${AZURE_RESOURCE_GROUP}" >> "$GITHUB_ENV"
          fi

      - name: Validate Azure resources exist
        shell: bash
        run: |
          set -euo pipefail
          az group show --name "$AZURE_RESOURCE_GROUP" --output none
          az webapp show --resource-group "$AZURE_RESOURCE_GROUP" --name "$AZURE_WEBAPP_NAME" --output none
          az acr show --name "$ACR_NAME" --output none
          az group show --name "$AZURE_STORAGE_RESOURCE_GROUP" --output none
          az storage account show --resource-group "$AZURE_STORAGE_RESOURCE_GROUP" --name "$AZURE_STORAGE_ACCOUNT" --output none

      - name: Ensure persistent SQLite file share exists
        shell: bash
        run: |
          set -euo pipefail
          az storage share-rm create \
            --resource-group "$AZURE_STORAGE_RESOURCE_GROUP" \
            --storage-account "$AZURE_STORAGE_ACCOUNT" \
            --name "$AZURE_FILE_SHARE" \
            --quota 5 \
            --output none

      - name: ACR login through Azure CLI
        shell: bash
        run: |
          set -euo pipefail
          az acr login --name "$ACR_NAME"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Azure Web App (set container image)
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_REF="${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${GITHUB_SHA}"
          az webapp config set \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --linux-fx-version "DOCKER|${IMAGE_REF}" \
            --output none

          # Explicit restart makes image swap timing deterministic before smoke checks.
          az webapp restart \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --output none

      - name: Configure Azure Files mount + SQLite DATABASE_URL
        shell: bash
        run: |
          set -euo pipefail

          STORAGE_KEY="$(az storage account keys list \
            --resource-group "$AZURE_STORAGE_RESOURCE_GROUP" \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --query "[0].value" -o tsv)"
          echo "::add-mask::$STORAGE_KEY"

          # Recreate mount idempotently to avoid stale mount definitions.
          az webapp config storage-account delete \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --custom-id sqlite-data \
            --output none || true

          az webapp config storage-account add \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --custom-id sqlite-data \
            --storage-type AzureFiles \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --share-name "$AZURE_FILE_SHARE" \
            --access-key "$STORAGE_KEY" \
            --mount-path "$SQLITE_MOUNT_PATH" \
            --output none

          az webapp config appsettings set \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --settings \
              DATABASE_URL="file:${SQLITE_MOUNT_PATH}/${SQLITE_DB_FILENAME}" \
              WEBSITES_PORT=3000 \
              PORT=3000 \
            --output none

          az webapp restart \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --output none

      - name: Ensure public access policy (avoid platform-level 403)
        shell: bash
        run: |
          set -euo pipefail

          # Keep public endpoint enabled for the production web app.
          az webapp update \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --set publicNetworkAccess=Enabled \
            --output none

          # Disable App Service built-in auth to avoid unauthenticated 401/403 unless intentionally enabled.
          az webapp auth update \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --enabled false \
            --output none

          # Also disable AuthSettingsV2 explicitly (Easy Auth v2), which can still enforce 401/403.
          az resource update \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --namespace Microsoft.Web \
            --resource-type sites/config \
            --name "${AZURE_WEBAPP_NAME}/authsettingsV2" \
            --set \
              properties.platform.enabled=false \
              properties.globalValidation.requireAuthentication=false \
              properties.globalValidation.unauthenticatedClientAction=AllowAnonymous \
            --output none || true

          # Remove any explicit main-site IP restriction rules that may still block all traffic.
          while IFS= read -r RULE_NAME; do
            [[ -z "$RULE_NAME" ]] && continue
            echo "Removing main-site access restriction rule: $RULE_NAME"
            az webapp config access-restriction remove \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$AZURE_WEBAPP_NAME" \
              --rule-name "$RULE_NAME" \
              --output none || true
          done < <(
            az webapp config access-restriction show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$AZURE_WEBAPP_NAME" \
              --query "ipSecurityRestrictions[].name" \
              -o tsv
          )

          # Remove explicit scm-site restriction rules as well.
          while IFS= read -r RULE_NAME; do
            [[ -z "$RULE_NAME" ]] && continue
            echo "Removing scm-site access restriction rule: $RULE_NAME"
            az webapp config access-restriction remove \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$AZURE_WEBAPP_NAME" \
              --rule-name "$RULE_NAME" \
              --scm-site true \
              --output none || true
          done < <(
            az webapp config access-restriction show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$AZURE_WEBAPP_NAME" \
              --query "scmIpSecurityRestrictions[].name" \
              -o tsv
          )

          # Ensure IP restrictions default to Allow for main and scm sites.
          az webapp config access-restriction set \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --use-same-restrictions-for-scm-site false \
            --default-action Allow \
            --scm-default-action Allow \
            --output none

          # Print non-sensitive policy snapshot for debugging.
          az webapp auth show \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --query "{enabled:enabled,unauthenticatedAction:unauthenticatedClientAction}" \
            -o table
          az resource show \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --namespace Microsoft.Web \
            --resource-type sites/config \
            --name "${AZURE_WEBAPP_NAME}/authsettingsV2" \
            --query "{v2Enabled:properties.platform.enabled,requireAuth:properties.globalValidation.requireAuthentication,unauthenticatedAction:properties.globalValidation.unauthenticatedClientAction}" \
            -o table || true
          az webapp config access-restriction show \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --query "{mainDefault:ipSecurityRestrictionsDefaultAction,scmDefault:scmIpSecurityRestrictionsDefaultAction}" \
            -o table

  smoke-test:
    name: Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: deploy
    env:
      AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME || secrets.AZURE_WEBAPP_NAME }}
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Health check - Homepage
        shell: bash
        run: |
          set -euo pipefail
          URL="https://${AZURE_WEBAPP_NAME}.azurewebsites.net"
          ACCEPTED_CODES_REGEX='^(200|301|302)$'
          for attempt in {1..12}; do
            STATUS=$(curl --connect-timeout 5 --max-time 20 -o /dev/null -s -w "%{http_code}" "$URL" || true)
            echo "Homepage attempt ${attempt}: ${STATUS:-no-response}"
            if [[ "${STATUS:-}" =~ $ACCEPTED_CODES_REGEX ]]; then
              exit 0
            fi
            sleep 10
          done
          echo "::error::Homepage health check failed for $URL"
          exit 1

      - name: Health check - API
        shell: bash
        run: |
          set -euo pipefail
          URL="https://${AZURE_WEBAPP_NAME}.azurewebsites.net/api/agents?q=test"
          ACCEPTED_CODES_REGEX='^(200|301|302)$'
          for attempt in {1..12}; do
            STATUS=$(curl --connect-timeout 5 --max-time 20 -o /dev/null -s -w "%{http_code}" "$URL" || true)
            echo "API attempt ${attempt}: ${STATUS:-no-response}"
            if [[ "${STATUS:-}" =~ $ACCEPTED_CODES_REGEX ]]; then
              exit 0
            fi
            sleep 10
          done
          echo "::error::API health check failed for $URL"
          exit 1

      - name: Print deployment URL
        run: echo "Deployed to https://${AZURE_WEBAPP_NAME}.azurewebsites.net"
